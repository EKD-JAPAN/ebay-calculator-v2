<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>eBay利益計算アプリ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        .tab-active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
            font-weight: bold;
        }
        .tab-inactive {
            border-bottom: 2px solid transparent;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans pb-20">

    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-10 flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center gap-2">
            <i data-lucide="calculator"></i>
            eBay利益計算
        </h1>
        <button id="modeToggleBtn" onclick="toggleMode()" class="text-sm bg-blue-700 hover:bg-blue-800 px-3 py-1.5 rounded-md flex items-center gap-1 transition-colors">
            <i data-lucide="layers" class="w-4 h-4"></i>
            <span id="modeToggleText">複数モードへ</span>
        </button>
    </header>

    <main class="max-w-3xl mx-auto p-4 space-y-6 mt-4">

        <!-- Input Section -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <h2 class="text-lg font-semibold border-b pb-2 mb-4 flex items-center gap-2">
                <i data-lucide="edit-3" class="w-5 h-5 text-blue-500"></i>
                入力情報
            </h2>

            <div class="space-y-4">
                <!-- 商品名とeBay検索 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">商品名 (任意)</label>
                    <div class="flex gap-2">
                        <input type="text" id="productName" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="例: Nikon F3">
                        <button onclick="searchEbay()" class="bg-gray-800 hover:bg-gray-900 text-white px-4 rounded-lg flex items-center justify-center transition whitespace-nowrap font-medium shadow-sm" title="eBayで相場を調べる">
                            <i data-lucide="search" class="w-4 h-4 mr-1"></i> eBay
                        </button>
                    </div>
                </div>

                <!-- 金額・レート設定 -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">出品価格 ($)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-500">$</span>
                            <input type="number" id="sellPrice" class="w-full border border-gray-300 rounded-lg p-2.5 pl-7 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0" oninput="calculate()">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">為替レート (円/ドル)</label>
                        <div class="flex gap-2">
                            <input type="number" id="exchangeRate" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="150" oninput="calculate()">
                            <button onclick="fetchExchangeRate()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-300 rounded-lg px-3 flex items-center justify-center transition" title="最新レートを取得">
                                <i data-lucide="refresh-cw" class="w-4 h-4" id="rateIcon"></i>
                            </button>
                        </div>
                        <p id="rateMsg" class="text-xs text-green-600 mt-1 hidden">取得完了</p>
                    </div>
                </div>

                <!-- 仕入・手数料・送料 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">仕入価格 (円) <span class="text-xs text-red-500">※税込額を入力</span></label>
                    <div class="relative">
                        <span class="absolute left-3 top-2.5 text-gray-500">¥</span>
                        <input type="number" id="purchasePrice" class="w-full border border-gray-300 rounded-lg p-2.5 pl-7 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0" oninput="calculate()">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">手数料 (%)</label>
                        <div class="relative">
                            <input type="number" id="feePercent" class="w-full border border-gray-300 rounded-lg p-2.5 pr-7 focus:ring-2 focus:ring-blue-500 outline-none" value="15" oninput="calculate()">
                            <span class="absolute right-3 top-2.5 text-gray-500">%</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">送料 (円)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-500">¥</span>
                            <input type="number" id="shippingCost" class="w-full border border-gray-300 rounded-lg p-2.5 pl-7 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0" oninput="calculate()">
                        </div>
                    </div>
                </div>

                <!-- メモ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">メモ (任意)</label>
                    <textarea id="memo" rows="2" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="付属品や特記事項など"></textarea>
                </div>
            </div>
            
            <div class="mt-4 flex gap-2">
                <button onclick="calculate()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg flex justify-center items-center gap-2 transition-colors">
                    <i data-lucide="calculator" class="w-5 h-5"></i> 計算する
                </button>
                <button onclick="clearForm()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 px-4 rounded-lg flex justify-center items-center transition-colors" title="クリア">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
            </div>
        </section>

        <!-- Results Section -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <i data-lucide="bar-chart-2" class="w-5 h-5 text-green-500"></i>
                    計算結果
                </h2>
                <button onclick="shareResult()" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-md flex items-center gap-1 transition">
                    <i data-lucide="share-2" class="w-4 h-4"></i> シェア
                </button>
            </div>

            <div class="space-y-4">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 text-center">
                    <p class="text-sm text-blue-800 font-medium mb-1">想定利益</p>
                    <p class="text-3xl font-bold text-blue-600" id="resProfit">¥ 0</p>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 text-center">
                        <p class="text-xs text-gray-500 font-medium mb-1">利益率</p>
                        <p class="text-lg font-bold text-gray-800" id="resMargin">0 %</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 text-center">
                        <p class="text-xs text-gray-500 font-medium mb-1">消費税還付金</p>
                        <p class="text-lg font-bold text-green-600" id="resTaxRefund">¥ 0</p>
                    </div>
                </div>

                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 flex justify-between items-center">
                    <p class="text-sm text-gray-600 font-medium">損益分岐点 (利益0円)</p>
                    <p class="text-lg font-bold text-red-500" id="resBreakEven">$ 0</p>
                </div>
            </div>
        </section>

        <!-- Camera Section -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <h2 class="text-lg font-semibold border-b pb-2 mb-4 flex items-center gap-2">
                <i data-lucide="camera" class="w-5 h-5 text-purple-500"></i>
                撮影メモ
            </h2>
            <div class="text-center">
                <input type="file" accept="image/*" capture="environment" id="cameraInput" class="hidden" onchange="handleImage(event)">
                <button onclick="document.getElementById('cameraInput').click()" class="w-full bg-purple-50 hover:bg-purple-100 text-purple-700 border border-purple-200 font-medium py-3 rounded-lg flex justify-center items-center gap-2 transition">
                    <i data-lucide="camera" class="w-5 h-5"></i> カメラを起動 / 画像を選択
                </button>
                
                <div id="imagePreviewContainer" class="mt-4 hidden">
                    <img id="imagePreview" src="" alt="プレビュー" class="w-full rounded-lg border border-gray-200 shadow-sm max-h-64 object-contain">
                    <button onclick="clearImage()" class="mt-2 text-sm text-red-500 hover:text-red-700 flex items-center justify-center w-full gap-1">
                        <i data-lucide="x-circle" class="w-4 h-4"></i> 画像を削除
                    </button>
                </div>
            </div>
        </section>

        <!-- Multi Product Mode Section (Hidden by default) -->
        <section id="multiModeSection" class="hidden bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <i data-lucide="list" class="w-5 h-5 text-orange-500"></i>
                    複数商品リスト
                </h2>
                <button onclick="exportCSV()" class="text-sm bg-green-50 text-green-700 border border-green-200 hover:bg-green-100 px-3 py-1.5 rounded-md flex items-center gap-1 transition">
                    <i data-lucide="download" class="w-4 h-4"></i> CSV
                </button>
            </div>
            
            <button onclick="addToList()" class="w-full mb-4 bg-orange-100 hover:bg-orange-200 text-orange-700 font-bold py-2 rounded-lg flex justify-center items-center gap-2 transition-colors">
                <i data-lucide="plus-circle" class="w-5 h-5"></i> 現在の計算結果をリストに追加
            </button>

            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-700 bg-gray-50 border-b">
                        <tr>
                            <th class="px-3 py-2">商品名</th>
                            <th class="px-3 py-2">利益</th>
                            <th class="px-3 py-2">操作</th>
                        </tr>
                    </thead>
                    <tbody id="productList">
                        <!-- Items will be injected here -->
                        <tr>
                            <td colspan="3" class="px-3 py-4 text-center text-gray-500">リストは空です</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-100 flex justify-between items-center">
                <span class="font-medium text-blue-800">合計想定利益:</span>
                <span class="font-bold text-xl text-blue-600" id="totalProfitList">¥ 0</span>
            </div>
        </section>

    </main>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg transition-opacity duration-300 opacity-0 pointer-events-none z-50 flex items-center gap-2">
        <i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i>
        <span id="toastMsg">通知メッセージ</span>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Application State
        let isMultiMode = false;
        let savedProducts = [];
        let currentResult = {
            profit: 0, margin: 0, taxRefund: 0, breakEven: 0
        };

        // DOM Elements
        const els = {
            productName: document.getElementById('productName'),
            sellPrice: document.getElementById('sellPrice'),
            exchangeRate: document.getElementById('exchangeRate'),
            purchasePrice: document.getElementById('purchasePrice'),
            feePercent: document.getElementById('feePercent'),
            shippingCost: document.getElementById('shippingCost'),
            memo: document.getElementById('memo'),
            resProfit: document.getElementById('resProfit'),
            resMargin: document.getElementById('resMargin'),
            resTaxRefund: document.getElementById('resTaxRefund'),
            resBreakEven: document.getElementById('resBreakEven')
        };

        // ---- Core Logic ----

        function calculate() {
            const sellPriceUSD = parseFloat(els.sellPrice.value) || 0;
            const exchangeRate = parseFloat(els.exchangeRate.value) || 0;
            const purchasePriceJPY = parseFloat(els.purchasePrice.value) || 0;
            const feePercent = parseFloat(els.feePercent.value) || 0;
            const shippingJPY = parseFloat(els.shippingCost.value) || 0;

            // 1. 売上(円)
            const salesJPY = Math.floor(sellPriceUSD * exchangeRate);
            
            // 2. 手数料(円)
            const feeJPY = Math.floor(salesJPY * (feePercent / 100));
            
            // 3. 消費税還付金 (購入金額 × 10/110)
            const taxRefund = Math.floor(purchasePriceJPY * (10 / 110));
            
            // 4. 想定利益 = 売上 - 手数料 - 送料 - 仕入 + 還付金
            const profit = salesJPY - feeJPY - shippingJPY - purchasePriceJPY + taxRefund;
            
            // 5. 利益率
            const margin = salesJPY > 0 ? ((profit / salesJPY) * 100).toFixed(1) : 0;
            
            // 6. 損益分岐点($) = (仕入 + 送料 - 還付金) / (レート * (1 - 手数料率))
            let breakEvenUSD = 0;
            const denominator = exchangeRate * (1 - (feePercent / 100));
            if (denominator > 0) {
                breakEvenUSD = Math.ceil((purchasePriceJPY + shippingJPY - taxRefund) / denominator);
            }

            // Update State
            currentResult = { profit, margin, taxRefund, breakEvenUSD };

            // Update UI
            els.resProfit.textContent = `¥ ${profit.toLocaleString()}`;
            els.resProfit.className = profit >= 0 ? "text-3xl font-bold text-blue-600" : "text-3xl font-bold text-red-600";
            
            els.resMargin.textContent = `${margin} %`;
            els.resTaxRefund.textContent = `¥ ${taxRefund.toLocaleString()}`;
            els.resBreakEven.textContent = `$ ${breakEvenUSD.toLocaleString()}`;
        }

        function clearForm() {
            els.productName.value = '';
            els.sellPrice.value = '';
            // keep exchange rate and fee percent usually
            els.purchasePrice.value = '';
            els.shippingCost.value = '';
            els.memo.value = '';
            clearImage();
            calculate();
            showToast('フォームをクリアしました');
        }

        // ---- eBay Search ----
        function searchEbay() {
            const query = els.productName.value.trim();
            if (!query) {
                showToast('商品名を入力してください');
                return;
            }
            // eBayの検索URLを開く
            const url = `https://www.ebay.com/sch/i.html?_nkw=${encodeURIComponent(query)}`;
            window.open(url, '_blank');
        }

        // ---- Exchange Rate API ----
        async function fetchExchangeRate() {
            const icon = document.getElementById('rateIcon');
            const msg = document.getElementById('rateMsg');
            icon.classList.add('animate-spin');
            msg.classList.add('hidden');
            
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                const data = await response.json();
                if (data && data.rates && data.rates.JPY) {
                    els.exchangeRate.value = Math.floor(data.rates.JPY);
                    calculate();
                    msg.textContent = '取得完了';
                    msg.classList.remove('hidden', 'text-red-600');
                    msg.classList.add('text-green-600');
                } else {
                    throw new Error('Rate not found');
                }
            } catch (error) {
                msg.textContent = '取得失敗';
                msg.classList.remove('hidden', 'text-green-600');
                msg.classList.add('text-red-600');
            } finally {
                icon.classList.remove('animate-spin');
            }
        }

        // ---- Camera / Image Handling ----
        function handleImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('imagePreview');
                    img.src = e.target.result;
                    document.getElementById('imagePreviewContainer').classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            }
        }

        function clearImage() {
            document.getElementById('cameraInput').value = '';
            document.getElementById('imagePreview').src = '';
            document.getElementById('imagePreviewContainer').classList.add('hidden');
        }

        // ---- Share Feature ----
        async function shareResult() {
            const text = `
【eBay利益計算】
商品名: ${els.productName.value || '未入力'}
出品価格: $${els.sellPrice.value || 0}
仕入価格: ¥${els.purchasePrice.value || 0}
想定利益: ¥${currentResult.profit.toLocaleString()}
利益率: ${currentResult.margin}%
損益分岐点: $${currentResult.breakEvenUSD.toLocaleString()}
消費税還付金: ¥${currentResult.taxRefund.toLocaleString()}
メモ: ${els.memo.value || 'なし'}
            `.trim();

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'eBay利益計算結果',
                        text: text
                    });
                } catch (err) {
                    console.log('Share canceled', err);
                }
            } else {
                // Fallback to clipboard
                navigator.clipboard.writeText(text).then(() => {
                    showToast('結果をクリップボードにコピーしました');
                });
            }
        }

        // ---- Multi Mode Features ----
        function toggleMode() {
            isMultiMode = !isMultiMode;
            const section = document.getElementById('multiModeSection');
            const btnText = document.getElementById('modeToggleText');
            
            if (isMultiMode) {
                section.classList.remove('hidden');
                btnText.textContent = '単一モードへ';
                renderList();
            } else {
                section.classList.add('hidden');
                btnText.textContent = '複数モードへ';
            }
        }

        function addToList() {
            const name = els.productName.value || '名称未設定';
            if (!els.sellPrice.value && !els.purchasePrice.value) {
                showToast('金額が入力されていません');
                return;
            }

            savedProducts.push({
                id: Date.now(),
                name: name,
                sellPrice: els.sellPrice.value,
                purchasePrice: els.purchasePrice.value,
                profit: currentResult.profit,
                margin: currentResult.margin,
                taxRefund: currentResult.taxRefund,
                breakEven: currentResult.breakEvenUSD
            });

            renderList();
            showToast('リストに追加しました');
        }

        function removeFromList(id) {
            savedProducts = savedProducts.filter(p => p.id !== id);
            renderList();
        }

        function renderList() {
            const tbody = document.getElementById('productList');
            tbody.innerHTML = '';
            
            let totalProfit = 0;

            if (savedProducts.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="px-3 py-4 text-center text-gray-500">リストは空です</td></tr>`;
                document.getElementById('totalProfitList').textContent = `¥ 0`;
                return;
            }

            savedProducts.forEach(p => {
                totalProfit += p.profit;
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="px-3 py-3 font-medium text-gray-900 truncate max-w-[120px]" title="${p.name}">${p.name}</td>
                    <td class="px-3 py-3 ${p.profit >= 0 ? 'text-blue-600' : 'text-red-600'} font-bold">¥${p.profit.toLocaleString()}</td>
                    <td class="px-3 py-3">
                        <button onclick="removeFromList(${p.id})" class="text-red-500 hover:text-red-700 p-1">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('totalProfitList').textContent = `¥ ${totalProfit.toLocaleString()}`;
            lucide.createIcons(); // Re-initialize icons for new DOM elements
        }

        function exportCSV() {
            if (savedProducts.length === 0) {
                showToast('出力するデータがありません');
                return;
            }

            // CSV Header
            let csvContent = "商品名,出品価格($),仕入価格(円),想定利益(円),利益率(%),消費税還付金(円),損益分岐点($)\n";
            
            // CSV Rows
            savedProducts.forEach(p => {
                // Escape commas in names
                const safeName = `"${p.name.replace(/"/g, '""')}"`;
                csvContent += `${safeName},${p.sellPrice},${p.purchasePrice},${p.profit},${p.margin},${p.taxRefund},${p.breakEven}\n`;
            });

            // BOM for Excel compatibility with Japanese
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `ebay_calc_export_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('CSVを出力しました');
        }

        // ---- UI Helpers ----
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 3000);
        }

        // Initial Calculation
        calculate();
        fetchExchangeRate(); // Try fetching initial rate
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eBay利益計算アプリ</title>
    <!-- Tailwind CSS CDNを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Google Fonts 'Inter' を読み込み */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-500 to-purple-600 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mx-auto text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 rounded-lg text-center">
            Zero One<br>eBay利益計算アプリ
        </h1>

        <!-- 商品カテゴリ -->
        <div class="mb-5 text-left">
            <label for="productCategory" class="block text-gray-700 text-sm font-semibold mb-2">
                商品カテゴリ (任意)
            </label>
            <select id="productCategory"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                    aria-label="商品カテゴリを選択">
                <option value="none" selected disabled>選択してください</option>
                <option value="SLR">SLR</option>
                <option value="Rangefinder">Rangefinder</option>
                <option value="point&shoot">Point&Shoot</option>
                <option value="lens">Lens</option>
                <option value="accessory">Accessory</option>
                <option value="other">その他</option>
            </select>
        </div>

        <!-- 商品名 -->
        <div class="mb-5 text-left">
            <label for="productName" class="block text-gray-700 text-sm font-semibold mb-2">
                商品名 (任意)
            </label>
            <input type="text" id="productName" placeholder="例: Nikon F3 Body" value=""
                   class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                   aria-label="商品名を入力">
        </div>

        <!-- コンディション入力欄とeBay参照ボタン -->
        <div class="mb-5 text-left">
            <label for="productCondition" class="block text-gray-700 text-sm font-semibold mb-2">
                コンディション (任意)
            </label>
            <div class="flex items-center space-x-2">
                <select id="productCondition"
                        class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                        aria-label="コンディションを選択">
                    <option value="none" selected disabled>選択してください</option>
                    <option value="TOP MINT">TOP MINT</option>
                    <option value="MINT">MINT</option>
                    <option value="NEAR MINT">NEAR MINT</option>
                    <option value="EX 5">EX 5</option>
                    <option value="EX 4">EX 4</option>
                    <option value="AS IS">AS IS</option>
                    <option value="FOR PARTS">FOR PARTS</option>
                </select>
                <button id="ebayReferenceButton"
                        class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 text-sm whitespace-nowrap">
                    eBay参照
                </button>
            </div>
        </div>


        <!-- 出品価格 ($) -->
        <div class="mb-5 text-left">
            <label for="listingPriceUsd" class="block text-gray-700 text-sm font-semibold mb-2">
                出品価格 ($) <span class="text-red-500 font-bold">*</span>
            </label>
            <input type="number" id="listingPriceUsd" placeholder="例: 100.00" step="0.01" value=""
                   class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                   aria-label="出品価格をドルで入力">
        </div>

        <!-- 為替レート (円/ドル) -->
        <div class="mb-5 text-left">
            <label for="exchangeRateJpyUsd" class="block text-gray-700 text-sm font-semibold mb-2">
                為替レート (円/ドル) <span class="text-red-500 font-bold">*</span>
            </label>
            <div class="flex items-center space-x-2">
                <input type="number" id="exchangeRateJpyUsd" placeholder="例: 155.00" step="0.01" value=""
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                       aria-label="為替レートを入力">
                <button id="fetchRateButton"
                        class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 text-sm whitespace-nowrap">
                    レート取得
                </button>
            </div>
            <p id="loadingMessage" class="text-blue-500 text-sm mt-2 hidden">
                レートを取得中...
            </p>
            <p id="rateErrorMessage" class="text-red-500 mt-2 text-sm hidden">
                レートの取得に失敗しました。手動で入力してください。
            </p>
        </div>

        <!-- 仕入価格 (円) -->
        <div class="mb-5 text-left">
            <label for="costPriceJpy" class="block text-gray-700 text-sm font-semibold mb-2">
                仕入価格 (円) <span class="text-red-500 font-bold">*</span> <span class="font-normal text-gray-500">(税込額を入力)</span>
            </label>
            <input type="number" id="costPriceJpy" placeholder="例: 5000" step="1" value=""
                   class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                   aria-label="仕入価格を日本円で入力">
        </div>

        <!-- 手数料 (%) -->
        <div class="mb-5 text-left">
            <label for="commissionPercentage" class="block text-gray-700 text-sm font-semibold mb-2">
                手数料 (%) <span class="text-red-500 font-bold">*</span>
            </label>
            <input type="number" id="commissionPercentage" placeholder="例: 15" step="0.1" value="15"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                   aria-label="手数料をパーセンテージで入力">
        </div>

        <!-- 送料 (円) -->
        <div class="mb-5 text-left">
            <label for="shippingCostJpy" class="block text-gray-700 text-sm font-semibold mb-2">
                送料 (円) <span class="font-normal text-gray-500">(Free Shipping設定時など、出品者が負担する送料)</span>
            </label>
            <input type="number" id="shippingCostJpy" placeholder="例: 1200" step="1" value=""
                   class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                   aria-label="送料を日本円で入力">
        </div>
        
        <!-- メモ欄 -->
        <div class="mb-6 text-left">
            <label for="memoText" class="block text-gray-700 text-sm font-semibold mb-2">
                メモ (任意)
            </label>
            <textarea id="memoText" placeholder="計算に関するメモをここに入力してください。" rows="3"
                      class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                      aria-label="メモ入力欄"></textarea>
        </div>


        <!-- 計算ボタン -->
        <button id="calculateButton"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
            計算
        </button>

        <!-- 計算結果表示エリア -->
        <div class="mt-8 text-left">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">
                計算結果
            </h2>
            <!-- 商品カテゴリと商品名を結果欄に表示 -->
            <div id="productInfoResult" class="bg-gray-100 p-4 rounded-lg mb-3">
                <p class="text-gray-600 text-sm font-semibold mb-1">商品情報</p>
                <div class="text-lg font-bold text-gray-800 break-all min-h-[32px] flex flex-col items-start justify-center">
                    <span id="resultCategory">カテゴリ: ---</span>
                    <span id="resultName">商品名: ---</span>
                    <span id="resultCondition">コンディション: ---</span>
                </div>
            </div>

            <div class="bg-gray-100 p-4 rounded-lg mb-3">
                <p class="text-gray-600 text-sm font-semibold mb-1">想定利益</p>
                <div id="expectedProfitResult"
                     class="text-3xl font-extrabold text-green-600 break-all min-h-[48px] flex items-center justify-center">
                    --- 円
                </div>
            </div>
            <div class="bg-gray-100 p-4 rounded-lg mb-3">
                <p class="text-gray-600 text-sm font-semibold mb-1">利益率</p>
                <div id="profitMarginResult"
                     class="text-3xl font-extrabold text-blue-600 break-all min-h-[48px] flex items-center justify-center">
                    --- %
                </div>
            </div>
            <div class="bg-gray-100 p-4 rounded-lg mb-3">
                <p class="text-gray-600 text-sm font-semibold mb-1">損益分岐点</p>
                <div id="breakevenPointResult"
                     class="text-3xl font-extrabold text-red-600 break-all min-h-[48px] flex items-center justify-center">
                    --- ドル
                </div>
            </div>
            <div class="bg-gray-100 p-4 rounded-lg">
                <p class="text-gray-600 text-sm font-semibold mb-1">消費税還付金</p>
                <div id="consumptionTaxRefundResult"
                     class="text-3xl font-extrabold text-purple-600 break-all min-h-[48px] flex items-center justify-center">
                    --- 円
                </div>
            </div>
            <p id="errorMessage" class="text-red-500 mt-4 text-sm hidden">
                有効な数値を入力してください。
            </p>
        </div>

        <!-- シェアボタン -->
        <div class="mt-8 flex justify-center space-x-4">
            <button id="shareButtonLine"
                    class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                LINEでシェア
            </button>
            <button id="shareButtonEmail"
                    class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                メールでシェア
            </button>
            <button id="shareButtonSystem"
                    class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                システムシェア
            </button>
        </div>

        <!-- 開発者情報 -->
        <!-- 開発者情報のdivを削除しました -->
    </div>

    <script>
        // HTML要素への参照を取得
        const productCategorySelect = document.getElementById('productCategory');
        const productNameInput = document.getElementById('productName');
        const productConditionSelect = document.getElementById('productCondition'); 
        const listingPriceUsdInput = document.getElementById('listingPriceUsd');
        const exchangeRateJpyUsdInput = document.getElementById('exchangeRateJpyUsd');
        const costPriceJpyInput = document.getElementById('costPriceJpy');
        const commissionPercentageInput = document.getElementById('commissionPercentage');
        const shippingCostJpyInput = document.getElementById('shippingCostJpy');
        const memoTextInput = document.getElementById('memoText');
        const calculateButton = document.getElementById('calculateButton');
        const fetchRateButton = document.getElementById('fetchRateButton');
        const ebayReferenceButton = document.getElementById('ebayReferenceButton');
        const shareButtonLine = document.getElementById('shareButtonLine');
        const shareButtonEmail = document.getElementById('shareButtonEmail');
        const shareButtonSystem = document.getElementById('shareButtonSystem'); // 追加

        const resultCategoryDiv = document.getElementById('resultCategory');
        const resultNameDiv = document.getElementById('resultName');
        const resultConditionDiv = document.getElementById('resultCondition'); 
        const expectedProfitResultDiv = document.getElementById('expectedProfitResult');
        const profitMarginResultDiv = document.getElementById('profitMarginResult');
        const breakevenPointResultDiv = document.getElementById('breakevenPointResult');
        const consumptionTaxRefundResultDiv = document.getElementById('consumptionTaxRefundResult');
        const errorMessageDiv = document.getElementById('errorMessage');
        const loadingMessageDiv = document.getElementById('loadingMessage');
        const rateErrorMessageDiv = document.getElementById('rateErrorMessage');

        // 計算結果を保持する変数
        let calculatedResults = {
            expectedProfitJpy: 0,
            profitMargin: 0,
            breakevenPointUsd: 0,
            consumptionTaxRefundJpy: 0
        };

        // 最後に参照したeBayリンクを保持する変数
        let lastEbayReferenceUrl = '';

        // 計算を実行する関数
        function performCalculation() {
            // エラーメッセージと結果をリセット
            errorMessageDiv.classList.add('hidden');
            expectedProfitResultDiv.textContent = '--- 円';
            profitMarginResultDiv.textContent = '--- %';
            breakevenPointResultDiv.textContent = '--- ドル';
            consumptionTaxRefundResultDiv.textContent = '--- 円';
            resultCategoryDiv.textContent = 'カテゴリ: ---';
            resultNameDiv.textContent = '商品名: ---';
            resultConditionDiv.textContent = 'コンディション: ---'; 

            // 入力値を取得し、数値に変換
            const listingPriceUsd = parseFloat(listingPriceUsdInput.value);
            const exchangeRateJpyUsd = parseFloat(exchangeRateJpyUsdInput.value);
            const costPriceJpy = parseFloat(costPriceJpyInput.value);
            const commissionPercentage = parseFloat(commissionPercentageInput.value);
            const shippingCostJpy = parseFloat(shippingCostJpyInput.value); 

            // 商品カテゴリと商品名を結果欄に表示
            const selectedCategory = productCategorySelect.value !== 'none' ? productCategorySelect.options[productCategorySelect.selectedIndex].text : '未選択';
            const inputProductName = productNameInput.value.trim() !== '' ? productNameInput.value.trim() : '未入力';
            const selectedCondition = productConditionSelect.value !== 'none' ? productConditionSelect.options[productConditionSelect.selectedIndex].text : '未選択'; 
            resultCategoryDiv.textContent = `カテゴリ: ${selectedCategory}`;
            resultNameDiv.textContent = `商品名: ${inputProductName}`;
            resultConditionDiv.textContent = `コンディション: ${selectedCondition}`; 

            // 必須入力項目のバリデーションを強化
            let validationMessages = [];

            if (isNaN(listingPriceUsd) || listingPriceUsd < 0 || listingPriceUsdInput.value.trim() === '') {
                validationMessages.push('「出品価格 ($)」に有効な数値を入力してください。');
            }
            if (isNaN(exchangeRateJpyUsd) || exchangeRateJpyUsd <= 0 || exchangeRateJpyUsdInput.value.trim() === '') {
                validationMessages.push('「為替レート (円/ドル)」に有効な数値を入力してください。');
            }
            if (isNaN(costPriceJpy) || costPriceJpy < 0 || costPriceJpyInput.value.trim() === '') {
                validationMessages.push('「仕入価格 (円)」に有効な数値を入力してください。');
            }
            if (isNaN(commissionPercentage) || commissionPercentage < 0 || commissionPercentage > 100 || commissionPercentageInput.value.trim() === '') {
                validationMessages.push('「手数料 (%)」に有効な数値を入力してください。(0～100%)');
            }
            // 送料は必須ではないので、isNaN(shippingCostJpy) は value="" の場合は 0 として扱う
            const finalShippingCostJpy = isNaN(shippingCostJpy) ? 0 : shippingCostJpy;


            if (validationMessages.length > 0) {
                errorMessageDiv.innerHTML = validationMessages.join('<br>');
                errorMessageDiv.classList.remove('hidden');
                return;
            }

            // 計算式の定義

            // 売上 (円) = 出品価格 ($) × 為替レート (円/ドル)
            const revenueJpy = listingPriceUsd * exchangeRateJpyUsd;

            // 手数料 (ドル) = 出品価格 ($) × 手数料率 (%)
            const commissionUsd = listingPriceUsd * (commissionPercentage / 100);
            // 手数料 (円) = 手数料 (ドル) × 為替レート (円/ドル)
            const commissionJpy = commissionUsd * exchangeRateJpyUsd;

            // 消費税還付金 (円) = 仕入価格 (円) × 0.10 (10%で計算)
            const consumptionTaxRefundJpy = costPriceJpy * 0.10;

            // 1. 想定利益 (JPY)
            // 想定利益 (円) = 売上 (円) - 手数料 (円) - 送料 (円) - 仕入価格 (円)
            // 注: 消費税還付金は別途表示し、想定利益には含めない
            const expectedProfitJpy = revenueJpy - commissionJpy - finalShippingCostJpy - costPriceJpy;

            // 2. 利益率 (%)
            // 利益率 (%) = (想定利益 (円) / 売上 (円)) × 100
            // 売上が0の場合は計算不可
            const profitMargin = (revenueJpy !== 0) ? (expectedProfitJpy / revenueJpy) * 100 : 0;

            // 3. 損益分岐点 (USD)
            // 想定利益が0になる出品価格 ($)
            // BEP_USD * exchangeRateJpyUsd - (BEP_USD * (commissionPercentage / 100)) * exchangeRateJpyUsd - shippingCostJpy - costPriceJpy = 0
            // BEP_USD * exchangeRateJpyUsd * (1 - commissionPercentage / 100) = shippingCostJpy + costPriceJpy
            // BEP_USD = (shippingCostJpy + costPriceJpy) / (exchangeRateJpyUsd * (1 - commissionPercentage / 100))
            let breakevenPointUsd;
            const denominator = exchangeRateJpyUsd * (1 - commissionPercentage / 100);
            if (denominator > 0) {
                breakevenPointUsd = (costPriceJpy + finalShippingCostJpy) / denominator;
            } else {
                breakevenPointUsd = Infinity; // もしくは適切なエラー表示
            }

            // 結果を更新
            calculatedResults.expectedProfitJpy = expectedProfitJpy;
            calculatedResults.profitMargin = profitMargin;
            calculatedResults.breakevenPointUsd = breakevenPointUsd;
            calculatedResults.consumptionTaxRefundJpy = consumptionTaxRefundJpy;

            // 結果を表示
            expectedProfitResultDiv.textContent = `${expectedProfitJpy.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY' })}`;
            profitMarginResultDiv.textContent = `${profitMargin.toFixed(2)} %`;
            breakevenPointResultDiv.textContent = `$ ${breakevenPointUsd.toFixed(2)}`;
            consumptionTaxRefundResultDiv.textContent = `${consumptionTaxRefundJpy.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY' })}`;
        }

        // 為替レートAPIキー
        const apiKey = "1372dbb55066a8afb68619d3"; 

        // 為替レートを取得する関数
        async function fetchExchangeRate() {
            loadingMessageDiv.classList.remove('hidden');
            rateErrorMessageDiv.classList.add('hidden');
            fetchRateButton.disabled = true;

            try {
                const apiUrl = `https://v6.exchangerate-api.com/v6/${apiKey}/latest/USD`; 
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.result === 'success' && data.conversion_rates && data.conversion_rates.JPY) {
                    const usdToJpyRate = data.conversion_rates.JPY;
                    exchangeRateJpyUsdInput.value = usdToJpyRate.toFixed(2);
                    performCalculation(); 
                } else {
                    rateErrorMessageDiv.textContent = 'レートの取得に失敗しました。APIエラーまたはデータ形式が不正です。';
                    rateErrorMessageDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('為替レートの取得中にエラーが発生しました:', error);
                rateErrorMessageDiv.textContent = 'レートの取得中にネットワークエラーが発生しました。';
                rateErrorMessageDiv.classList.remove('hidden');
            } finally {
                loadingMessageDiv.classList.add('hidden');
                fetchRateButton.disabled = false;
            }
        }

        // シェアメッセージを作成する関数
        function createShareMessage() {
            const category = productCategorySelect.value !== 'none' ? productCategorySelect.options[productCategorySelect.selectedIndex].text : '未選択';
            const name = productNameInput.value.trim() !== '' ? productNameInput.value.trim() : '商品名なし';
            const condition = productConditionSelect.value !== 'none' ? productConditionSelect.options[productConditionSelect.selectedIndex].text : '未入力'; 
            const listingPrice = listingPriceUsdInput.value ? `$${parseFloat(listingPriceUsdInput.value).toFixed(2)}` : '未入力';
            const rate = exchangeRateJpyUsdInput.value ? parseFloat(exchangeRateJpyUsdInput.value).toFixed(2) : '未入力';
            const cost = costPriceJpyInput.value ? parseFloat(costPriceJpyInput.value).toLocaleString('ja-JP') : '未入力';
            const commission = commissionPercentageInput.value ? parseFloat(commissionPercentageInput.value).toFixed(1) : '未入力';
            const shipping = shippingCostJpyInput.value ? parseFloat(shippingCostJpyInput.value).toLocaleString('ja-JP') : '未入力';
            const memo = memoTextInput.value.trim() !== '' ? `\nメモ: ${memoTextInput.value.trim()}\n` : '';
            const ebayLink = lastEbayReferenceUrl !== '' ? `\neBay参照リンク: ${lastEbayReferenceUrl}\n` : ''; 

            const profit = calculatedResults.expectedProfitJpy.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY' });
            const profitMargin = calculatedResults.profitMargin.toFixed(2);
            const breakeven = calculatedResults.breakevenPointUsd.toFixed(2);
            const refund = calculatedResults.consumptionTaxRefundJpy.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY' });

            return `【eBay利益計算結果】\n\nカテゴリ: ${category}\n商品名: ${name}\nコンディション: ${condition}\n\n出品価格: ${listingPrice}\n為替レート: ${rate} 円/ドル\n仕入価格: ${cost} 円\n手数料: ${commission} %\n送料: ${shipping} 円\n\n想定利益: ${profit}\n利益率: ${profitMargin} %\n損益分岐点: $${breakeven}\n消費税還付金: ${refund}${memo}${ebayLink}`;
        }

        // LINEでシェア
        shareButtonLine.addEventListener('click', () => {
            const message = createShareMessage();
            const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(message)}`;
            window.open(lineUrl, '_blank');
        });

        // メールでシェア
        shareButtonEmail.addEventListener('click', () => {
            const subject = encodeURIComponent('eBay利益計算結果');
            const body = encodeURIComponent(createShareMessage());
            const mailtoUrl = `mailto:?subject=${subject}&body=${body}`;
            window.open(mailtoUrl, '_blank');
        });

        // システムシェアボタンのイベントリスナー
        shareButtonSystem.addEventListener('click', async () => {
            if (navigator.share) {
                const shareText = createShareMessage();
                try {
                    await navigator.share({
                        title: 'eBay利益計算結果',
                        text: shareText,
                        url: window.location.href // 現在のアプリのURLを共有
                    });
                    console.log('コンテンツが正常に共有されました');
                } catch (error) {
                    console.error('コンテンツの共有中にエラーが発生しました:', error);
                    // ユーザーが共有をキャンセルした場合もエラーになるため、エラーメッセージは出さない
                }
            } else {
                errorMessageDiv.textContent = 'お使いのブラウザはシステムシェアに対応していません。';
                errorMessageDiv.classList.remove('hidden');
                setTimeout(() => errorMessageDiv.classList.add('hidden'), 5000); // 5秒後にメッセージを非表示
            }
        });

        // eBay参照ボタンのイベントリスナー
        ebayReferenceButton.addEventListener('click', () => {
            const productName = productNameInput.value.trim();
            const productCondition = productConditionSelect.value; 
            let searchQuery = productName;

            if (productCondition !== 'none' && productCondition.trim() !== '') { 
                searchQuery += ` ${productCondition}`; 
            }

            if (searchQuery.trim() !== '') {
                const encodedSearchQuery = encodeURIComponent(searchQuery);
                const ebaySearchUrl = `https://www.ebay.com/sch/i.html?_nkw=${encodedSearchQuery}&LH_Complete=1&LH_Sold=1&_sop=3`;
                
                lastEbayReferenceUrl = ebaySearchUrl;

                window.open(ebaySearchUrl, '_blank');
            } else {
                errorMessageDiv.textContent = '商品名を入力してください。';
                errorMessageDiv.classList.remove('hidden');
            }
        });


        // 計算ボタンがクリックされた時の処理
        calculateButton.addEventListener('click', performCalculation);

        // レート取得ボタンがクリックされた時の処理
        fetchRateButton.addEventListener('click', fetchExchangeRate);

        // ページ読み込み時に一度レートを取得し、初期計算を実行
        document.addEventListener('DOMContentLoaded', () => {
            fetchRateButton.click(); 
            performCalculation(); 
        });
    </script>
</body>

</html>
